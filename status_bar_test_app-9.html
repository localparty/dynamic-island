<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Status Bar Test</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;overflow:hidden;height:100vh}.status-bar{position:fixed;top:0;left:0;right:0;height:44px;background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);display:flex;justify-content:space-between;align-items:center;padding:0 20px;font-size:14px;font-weight:600;z-index:1000;transition:color 0.2s,text-shadow 0.2s;border-bottom:0.5px solid rgba(255,255,255,0.1)}.status-left,.status-right{display:flex;align-items:center;gap:8px;transition:all 0.2s}.signal-bars{display:flex;gap:2px}.signal-bar{width:3px;background:currentColor;border-radius:1px}.signal-bar:nth-child(1){height:4px}.signal-bar:nth-child(2){height:6px}.signal-bar:nth-child(3){height:8px}.signal-bar:nth-child(4){height:10px}.battery-icon{width:22px;height:11px;border:1.5px solid currentColor;border-radius:2px;position:relative}.battery-icon::after{content:'';position:absolute;right:-4px;top:2px;width:2px;height:5px;background:currentColor;border-radius:0 1px 1px 0}.battery-level{position:absolute;left:1px;top:1px;bottom:1px;width:70%;background:currentColor;border-radius:1px}.status-light{color:#fff!important;text-shadow:0 1px 3px rgba(0,0,0,0.8)}.status-dark{color:#1d1d1f!important;text-shadow:0 1px 3px rgba(255,255,255,0.8)}.device-container{position:absolute;top:44px;left:0;right:340px;bottom:0;background:#1a1a1a;border-right:1px solid #333}.device-frame{width:100%;height:100%;border:none;display:block}.debug-panel{position:fixed;top:44px;right:0;width:340px;bottom:0;background:#1c1c1e;color:#fff;padding:20px;overflow-y:auto;font-size:12px}.debug-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #333}.debug-section:last-child{border-bottom:none}.debug-title{font-size:14px;font-weight:700;margin-bottom:12px;color:#007aff}.debug-row{display:flex;justify-content:space-between;margin-bottom:8px;font-family:monospace}.debug-label{color:#8e8e93}.debug-value{color:#fff;font-weight:600}.status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}.status-indicator.idle{background:#34c759}.status-indicator.working{background:#ff9500;animation:pulse 1s infinite}.status-indicator.scrolling{background:#007aff;animation:pulse 0.5s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}.preview-item{margin-bottom:16px;padding:12px;background:#2c2c2e;border-radius:8px}.preview-label{font-size:11px;color:#8e8e93;margin-bottom:6px}.preview-canvas{width:100%;height:auto;border-radius:4px;border:1px solid #3a3a3c;background:#000;image-rendering:pixelated;margin-top:4px}.preview-stats{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:#fff}.test-controls{display:flex;flex-direction:column;gap:8px}.test-button{padding:8px 12px;background:#007aff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:background 0.2s}.test-button:hover{background:#0051d5}.test-button.secondary{background:#2c2c2e}.test-button.secondary:hover{background:#3a3a3c}.color-input-group{display:flex;align-items:center;gap:8px;margin-top:8px}.color-input-group input[type="color"]{width:40px;height:30px;border:none;border-radius:4px;cursor:pointer}.color-input-group label{font-size:11px;color:#8e8e93}.checkbox-group{display:flex;align-items:center;gap:8px;margin-top:8px}.checkbox-group input[type="checkbox"]{width:16px;height:16px}.checkbox-group label{font-size:11px;color:#8e8e93}.header-state{display:flex;align-items:center;gap:8px;padding:8px;background:#2c2c2e;border-radius:6px;margin-top:8px}.header-color-box{width:30px;height:30px;border-radius:4px;border:1px solid #3a3a3c}.header-info{flex:1;font-size:10px}.header-info-row{display:flex;justify-content:space-between;margin-bottom:2px}.event-log{background:#000;border-radius:6px;padding:8px;height:150px;overflow-y:auto;font-family:'Monaco','Courier New',monospace;font-size:10px;line-height:1.4}.log-entry{margin-bottom:2px;color:#8e8e93}.log-entry .timestamp{color:#007aff}.log-entry .event-type{color:#34c759}.log-entry .event-data{color:#fff}.brightness-bar{width:100%;height:8px;background:#2c2c2e;border-radius:4px;overflow:hidden;margin-top:4px}.brightness-fill{height:100%;background:linear-gradient(90deg,#000 0%,#fff 100%);transition:width 0.2s}.slider-group{margin-top:12px}.slider-group label{font-size:11px;color:#8e8e93;display:block;margin-bottom:6px}.slider-container{display:flex;align-items:center;gap:8px}.slider-container input[type="range"]{flex:1;height:4px;border-radius:2px;background:#3a3a3c;outline:none;-webkit-appearance:none}.slider-container input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#007aff;cursor:pointer}.slider-container input[type="range"]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#007aff;cursor:pointer;border:none}.slider-value{font-size:11px;color:#fff;font-weight:600;min-width:45px;text-align:right}</style></head><body><div class="status-bar" id="statusBar"><div class="status-left" id="statusLeft" data-analyze="true"><span id="timeDisplay">2:36 PM</span></div><div class="status-right" id="statusRight" data-analyze="true"><div class="signal-bars"><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div></div><span>ðŸ“¶</span><div class="battery-icon"><div class="battery-level"></div></div></div></div><div class="device-container"><iframe id="testIframe" class="device-frame"></iframe></div><div class="debug-panel"><div class="debug-section"><div class="debug-title">System Status</div><div class="debug-row"><span class="debug-label">Worker:</span><span class="debug-value"><span class="status-indicator idle" id="workerStatus"></span><span id="workerStatusText">Ready</span></span></div><div class="debug-row"><span class="debug-label">Scroll:</span><span class="debug-value"><span class="status-indicator idle" id="scrollStatus"></span><span id="scrollStatusText">Idle</span></span></div><div class="debug-row"><span class="debug-label">Scroll Pos:</span><span class="debug-value" id="scrollPosition">0px</span></div><div class="debug-row"><span class="debug-label">Velocity:</span><span class="debug-value" id="scrollVelocity">0 px/s</span></div></div><div class="debug-section"><div class="debug-title">Canvas Previews</div><div class="preview-item"><div class="preview-label">Time Element (Left)</div><canvas class="preview-canvas" id="previewLeft"></canvas><div class="preview-stats"><span>B: <span id="brightnessLeft">--</span></span><span>Mode: <span id="modeLeft">--</span></span><span>Time: <span id="timeLeft">--</span>ms</span></div></div><div class="preview-item"><div class="preview-label">Icons Element (Right)</div><canvas class="preview-canvas" id="previewRight"></canvas><div class="preview-stats"><span>B: <span id="brightnessRight">--</span></span><span>Mode: <span id="modeRight">--</span></span><span>Time: <span id="timeRight">--</span>ms</span></div></div></div><div class="debug-section"><div class="debug-title">Sampling Settings</div><div class="slider-group"><label>Idle Sampling Rate: <span id="samplingRateLabel">1 Hz</span></label><div class="slider-container"><input type="range" id="samplingRateSlider" min="1" max="20" value="1" step="1"><span class="slider-value" id="samplingRateValue">1 Hz</span></div></div></div><div class="debug-section"><div class="debug-title">Header State</div><div class="header-state"><div class="header-color-box" id="headerColorBox"></div><div class="header-info"><div class="header-info-row"><span>Visible:</span><span id="headerVisible">--</span></div><div class="header-info-row"><span>Color:</span><span id="headerColor">--</span></div></div></div></div><div class="debug-section"><div class="debug-title">Test Controls</div><div class="test-controls"><button class="test-button" onclick="testScrollToTop()">Scroll to Top</button><button class="test-button" onclick="testScrollToBottom()">Scroll to Bottom</button><button class="test-button" onclick="testScrollToDark()">Scroll to Dark</button><button class="test-button" onclick="testScrollToLight()">Scroll to Light</button><button class="test-button secondary" onclick="testChangeHeaderColor()">Change Color</button><button class="test-button secondary" onclick="testToggleHeader()">Toggle Header</button></div><div class="checkbox-group"><input type="checkbox" id="autoColorChange" checked><label for="autoColorChange">Auto Color (2s)</label></div><div class="color-input-group"><label>Color:</label><input type="color" id="manualHeaderColor" value="#3a7bd5"></div></div><div class="debug-section"><div class="debug-title">Event Log</div><div class="event-log" id="eventLog"></div></div></div><script>const iframeContent=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,sans-serif;overflow-x:hidden}.dynamic-header{position:fixed;top:0;left:0;right:0;height:60px;z-index:100;background:#3a7bd5;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;transition:transform .3s,background-color .3s;box-shadow:0 2px 10px rgba(0,0,0,.1)}.dynamic-header.hidden{transform:translateY(-100%)}.scrolling-content{position:relative;z-index:1;padding-top:60px}.content-section{min-height:100vh;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:800;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.3)}.section-1{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}.section-2{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}.section-3{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}.section-4{background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:#1d1d1f}.section-5{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:#1d1d1f}.section-6{background:linear-gradient(135deg,#a8edea 0%,#fed6e3 100%);color:#1d1d1f}.section-7{background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%)}.section-8{background:linear-gradient(to right,#667eea 0%,#fee140 50%,#f5576c 100%);color:#fff}</style></head><body><div class="dynamic-header" id="dynamicHeader">Dynamic Header (Z:100)</div><div class="scrolling-content"><div class="content-section section-1">Deep Purple</div><div class="content-section section-2">Hot Pink</div><div class="content-section section-3">Ocean Blue</div><div class="content-section section-4">Bright Green</div><div class="content-section section-5">Sunny Yellow</div><div class="content-section section-6">Soft Pastel</div><div class="content-section section-7">Storm Blue</div><div class="content-section section-8">Purple â†’ Yellow â†’ Pink</div></div><script>class DynamicHeader{constructor(){this.header=document.getElementById('dynamicHeader');this.lastScrollY=0;this.colors=['#FF6B6B','#4ECDC4','#45B7D1','#FFA07A','#98D8C8','#F7DC6F','#BB8FCE','#85929E','#2ECC71','#E74C3C','#3a7bd5','#FF1493'];this.autoColorChange=true;this.init()}init(){window.addEventListener('scroll',()=>this.handleScroll());this.startColorRotation();window.addEventListener('message',e=>{if(e.data.type==='set-header-color')this.setColor(e.data.color);else if(e.data.type==='toggle-header')this.toggle();else if(e.data.type==='set-auto-color')this.autoColorChange=e.data.enabled})}handleScroll(){const currentScrollY=window.scrollY;if(currentScrollY>this.lastScrollY&&currentScrollY>50){this.header.classList.add('hidden')}else{this.header.classList.remove('hidden')}this.lastScrollY=currentScrollY;this.notifyParent()}startColorRotation(){setInterval(()=>{if(this.autoColorChange){const randomColor=this.colors[Math.floor(Math.random()*this.colors.length)];this.setColor(randomColor)}},2000)}setColor(color){this.header.style.backgroundColor=color;this.notifyParent()}toggle(){this.header.classList.toggle('hidden');this.notifyParent()}notifyParent(){const bgColor=getComputedStyle(this.header).backgroundColor;const isVisible=!this.header.classList.contains('hidden');window.parent.postMessage({type:'header-state',color:bgColor,visible:isVisible,scrollY:window.scrollY},'*')}}new DynamicHeader()<\/script></body></html>`;document.getElementById('testIframe').srcdoc=iframeContent;const workerCode=`class ColorAnalysisWorker{constructor(){this.requestQueue=new Map();this.isProcessing=false}async handleMessage(e){const{imageData,method,requestId,elementId}=e.data;if(this.requestQueue.size>5){const oldestRequest=this.requestQueue.keys().next().value;this.requestQueue.delete(oldestRequest)}this.requestQueue.set(requestId,{imageData,method,elementId});if(!this.isProcessing)this.processQueue()}async processQueue(){this.isProcessing=true;while(this.requestQueue.size>0){const entries=Array.from(this.requestQueue.entries());const[requestId,request]=entries[entries.length-1];this.requestQueue.clear();const startTime=performance.now();const brightness=this.getPerceivedLuminance(request.imageData);const processingTime=performance.now()-startTime;self.postMessage({type:'analysis-complete',requestId,elementId:request.elementId,brightness:Math.round(brightness),shouldUseLightText:brightness<128,processingTime:Math.round(processingTime*100)/100});await new Promise(resolve=>setTimeout(resolve,1))}this.isProcessing=false}getPerceivedLuminance(imageData){const data=imageData.data;let luminance=0;for(let i=0;i<data.length;i+=16){const r=data[i]/255,g=data[i+1]/255,b=data[i+2]/255;const rsRGB=r<=0.03928?r/12.92:Math.pow((r+0.055)/1.055,2.4);const gsRGB=g<=0.03928?g/12.92:Math.pow((g+0.055)/1.055,2.4);const bsRGB=b<=0.03928?b/12.92:Math.pow((b+0.055)/1.055,2.4);luminance+=0.2126*rsRGB+0.7152*gsRGB+0.0722*bsRGB}return(luminance/(data.length/16))*255}}const worker=new ColorAnalysisWorker();self.onmessage=e=>worker.handleMessage(e);self.postMessage({type:'worker-ready'})`;const blob=new Blob([workerCode],{type:'application/javascript'});const workerUrl=URL.createObjectURL(blob);class IframeScrollBridge{constructor(iframe,scrollableElement){this.iframe=iframe;this.scrollableElement=scrollableElement;this.listeners=new Set();this.lastScrollY=0;this.scrollVelocity=0;this.lastScrollTime=performance.now()}start(){if(!this.scrollableElement)return;const getScrollData=type=>{const currentScrollY=this.scrollableElement.scrollTop;const currentTime=performance.now();const deltaTime=currentTime-this.lastScrollTime;const deltaScroll=currentScrollY-this.lastScrollY;if(deltaTime>0)this.scrollVelocity=Math.abs(deltaScroll/deltaTime*1000);this.lastScrollY=currentScrollY;this.lastScrollTime=currentTime;return{type,scrollY:currentScrollY,scrollX:this.scrollableElement.scrollLeft,velocity:this.scrollVelocity,timestamp:currentTime}};this.scrollableElement.addEventListener('scroll',()=>this.notifyListeners(getScrollData('iframe-scroll')),{passive:true});this.scrollableElement.addEventListener('touchstart',()=>this.notifyListeners(getScrollData('iframe-touchstart')),{passive:true});this.scrollableElement.addEventListener('touchend',()=>this.notifyListeners(getScrollData('iframe-touchend')),{passive:true});this.scrollableElement.addEventListener('wheel',()=>this.notifyListeners(getScrollData('iframe-wheel')),{passive:true});this.setupScrollEndDetection()}setupScrollEndDetection(){let scrollEndTimeout;this.scrollableElement.addEventListener('scroll',()=>{clearTimeout(scrollEndTimeout);scrollEndTimeout=setTimeout(()=>{this.notifyListeners({type:'iframe-scroll-end',scrollY:this.scrollableElement.scrollTop,velocity:0,timestamp:performance.now()});this.scrollVelocity=0},150)},{passive:true})}notifyListeners(data){this.listeners.forEach(callback=>callback(data))}addListener(callback){this.listeners.add(callback)}getCurrentScrollY(){return this.scrollableElement.scrollTop}}class StatusBarColorAnalyzer{constructor(options={}){this.statusBar=options.statusBar;this.iframeBridge=options.iframeBridge;this.scrollableContent=options.scrollableContent;this.scrollSource=options.scrollSource||'window';this.worker=null;this.requestId=0;this.pendingRequests=new Map();this.lastScrollY=0;this.scrollVelocity=0;this.isScrolling=false;this.scrollTimeout=null;this.momentumTimeout=null;this.lastFrameTime=performance.now();this.lastAnalysis=0;this.analysisThrottle=16;this.periodicInterval=null;this.samplingRate=1;this.statusBarElements=[];this.discoverStatusBarElements()}discoverStatusBarElements(){const elementsToAnalyze=this.statusBar.querySelectorAll('[data-analyze="true"]');elementsToAnalyze.forEach(element=>{const previewId=element.id==='statusLeft'?'previewLeft':'previewRight';const previewCanvas=document.getElementById(previewId);if(previewCanvas){const item={element:element,canvas:previewCanvas,ctx:previewCanvas.getContext('2d'),id:element.id};this.statusBarElements.push(item)}})}async init(){await this.initWorker();this.setupScrollTracking();this.setupPeriodicAnalysis();this.updateTime();setTimeout(()=>this.analyzeAllElements(),100)}async initWorker(){this.worker=new Worker(workerUrl);this.worker.onmessage=e=>{if(e.data.type==='analysis-complete')this.handleAnalysisComplete(e.data)};this.worker.onerror=()=>this.updateWorkerStatus('error','Error');await new Promise(resolve=>{const handleReady=e=>{if(e.data.type==='worker-ready'){this.worker.removeEventListener('message',handleReady);resolve()}};this.worker.addEventListener('message',handleReady)});this.updateWorkerStatus('idle','Ready')}setupScrollTracking(){let ticking=false;if(this.scrollSource==='iframe'&&this.iframeBridge){this.iframeBridge.addListener(eventData=>{switch(eventData.type){case 'iframe-scroll':case 'iframe-wheel':if(!ticking){requestAnimationFrame(()=>{this.handleIframeScroll(eventData);ticking=false});ticking=true}break;case 'iframe-touchstart':this.setScrollState('starting');break;case 'iframe-touchend':this.trackScrollMomentum();break;case 'iframe-scroll-end':this.setScrollState('idle');this.scrollVelocity=0;this.updateScrollUI();break}})}}setupPeriodicAnalysis(){this.updatePeriodicInterval()}updatePeriodicInterval(){if(this.periodicInterval){clearInterval(this.periodicInterval)}const intervalMs=1000/this.samplingRate;this.periodicInterval=setInterval(()=>{if(!this.isScrolling){this.analyzeAllElements();logEvent('periodic',`Rate: ${this.samplingRate}Hz`)}},intervalMs)}setSamplingRate(rate){this.samplingRate=rate;this.updatePeriodicInterval();logEvent('settings',`Sampling rate: ${rate}Hz`)}handleIframeScroll(scrollData){const currentScrollY=scrollData.scrollY;const currentTime=scrollData.timestamp||performance.now();const deltaTime=currentTime-this.lastFrameTime;const deltaScroll=currentScrollY-this.lastScrollY;if(deltaTime>0)this.scrollVelocity=Math.abs(deltaScroll/deltaTime*1000);this.lastScrollY=currentScrollY;this.setScrollState('active');if(currentTime-this.lastAnalysis>=this.analysisThrottle){this.analyzeAllElements();this.lastAnalysis=currentTime}this.updateScrollUI();clearTimeout(this.scrollTimeout);this.scrollTimeout=setTimeout(()=>{if(this.scrollVelocity<10)this.setScrollState('idle')},150);this.trackScrollMomentum()}trackScrollMomentum(){clearTimeout(this.momentumTimeout);const checkMomentum=()=>{const currentScrollY=this.getCurrentScrollY();if(Math.abs(currentScrollY-this.lastScrollY)>1){this.lastScrollY=currentScrollY;this.momentumTimeout=setTimeout(checkMomentum,50);if(!this.isScrolling)this.setScrollState('momentum');this.analyzeAllElements();this.updateScrollUI()}else{this.setScrollState('idle');this.scrollVelocity=0;this.updateScrollUI()}};this.momentumTimeout=setTimeout(checkMomentum,50)}getCurrentScrollY(){if(this.scrollSource==='iframe'&&this.scrollableContent)return this.scrollableContent.scrollTop;return window.scrollY}setScrollState(state){this.isScrolling=state!=='idle';document.getElementById('scrollStatus').className=`status-indicator ${state==='idle'?'idle':'scrolling'}`;document.getElementById('scrollStatusText').textContent=state.charAt(0).toUpperCase()+state.slice(1)}analyzeAllElements(){this.statusBarElements.forEach(item=>{this.analyzeElement(item)})}analyzeElement(item){const rect=item.element.getBoundingClientRect();item.canvas.width=rect.width;item.canvas.height=rect.height;this.sampleRegionForElement(item,rect);const imageData=item.ctx.getImageData(0,0,rect.width,rect.height);this.requestId++;this.pendingRequests.set(this.requestId,{element:item.element,id:item.id,timestamp:performance.now()});this.worker.postMessage({type:'analyze',imageData:imageData,requestId:this.requestId,elementId:item.id})}sampleRegionForElement(item,rect){const iframe=this.iframeBridge?.iframe;if(!iframe?.contentDocument)return;const iframeDoc=iframe.contentDocument;const iframeWindow=iframe.contentWindow;const iframeRect=iframe.getBoundingClientRect();item.ctx.fillStyle='#f5f5f7';item.ctx.fillRect(0,0,rect.width,rect.height);const samplesX=Math.max(10,Math.ceil(rect.width/20));const samplesY=Math.max(3,Math.ceil(rect.height/10));for(let y=0;y<samplesY;y++){const sampleY=(rect.height/samplesY)*y+(rect.height/samplesY/2);for(let x=0;x<samplesX;x++){const sampleX=(rect.width/samplesX)*x+(rect.width/samplesX/2);const viewportX=rect.left+sampleX;const viewportY=rect.top+sampleY;if(viewportX>=iframeRect.left&&viewportX<=iframeRect.right&&viewportY>=iframeRect.top&&viewportY<=iframeRect.bottom){const element=iframeDoc.elementFromPoint(viewportX,viewportY);if(element){const color=this.getElementColorAtPoint(element,iframeWindow);const rectWidth=rect.width/samplesX;const rectHeight=rect.height/samplesY;item.ctx.fillStyle=color;item.ctx.fillRect(x*rectWidth,y*rectHeight,rectWidth,rectHeight)}}}}}getElementColorAtPoint(element,iframeWindow){const computed=iframeWindow.getComputedStyle(element);let bgColor=computed.backgroundColor;if(bgColor==='rgba(0, 0, 0, 0)'||bgColor==='transparent'){let parent=element.parentElement;while(parent&&(bgColor==='rgba(0, 0, 0, 0)'||bgColor==='transparent')){bgColor=iframeWindow.getComputedStyle(parent).backgroundColor;parent=parent.parentElement}}if(bgColor==='rgba(0, 0, 0, 0)'||bgColor==='transparent')bgColor='rgb(255, 255, 255)';const bgImage=computed.backgroundImage;if(bgImage&&bgImage!=='none'&&!bgImage.startsWith('url(')){return this.approximateGradientColor(bgImage)}return bgColor}approximateGradientColor(gradientString){const colorMatch=gradientString.match(/rgba?\([^)]+\)/);if(colorMatch)return colorMatch[0];const hexMatch=gradientString.match(/#[0-9a-fA-F]{3,6}/);if(hexMatch)return hexMatch[0];return'rgb(128, 128, 128)'}handleAnalysisComplete(data){const{requestId,elementId,brightness,shouldUseLightText,processingTime}=data;if(this.pendingRequests.has(requestId)){const info=this.pendingRequests.get(requestId);this.pendingRequests.delete(requestId);this.updateElementColor(info.element,shouldUseLightText);this.updateElementUI(elementId,brightness,shouldUseLightText,processingTime)}this.updateWorkerStatus('idle','Ready')}updateElementColor(element,shouldUseLightText){if(shouldUseLightText){element.classList.add('status-light');element.classList.remove('status-dark')}else{element.classList.add('status-dark');element.classList.remove('status-light')}}updateElementUI(elementId,brightness,shouldUseLightText,processingTime){const side=elementId==='statusLeft'?'Left':'Right';document.getElementById(`brightness${side}`).textContent=brightness;document.getElementById(`mode${side}`).textContent=shouldUseLightText?'Light':'Dark';document.getElementById(`time${side}`).textContent=processingTime}updateWorkerStatus(status,text){document.getElementById('workerStatus').className=`status-indicator ${status}`;document.getElementById('workerStatusText').textContent=text}updateScrollUI(){document.getElementById('scrollVelocity').textContent=Math.round(this.scrollVelocity)+' px/s';document.getElementById('scrollPosition').textContent=Math.round(this.getCurrentScrollY())+'px'}updateTime(){const now=new Date();const timeString=now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});document.getElementById('timeDisplay').textContent=timeString;setTimeout(()=>this.updateTime(),1000)}}const logEntries=[];const maxLogEntries=50;function logEvent(type,data){const timestamp=new Date().toLocaleTimeString('en-US',{hour12:false,fractionalSecondDigits:3});logEntries.unshift({timestamp,type,data});if(logEntries.length>maxLogEntries)logEntries.pop();updateEventLog()}function updateEventLog(){const logContainer=document.getElementById('eventLog');logContainer.innerHTML=logEntries.map(entry=>`<div class="log-entry"><span class="timestamp">[${entry.timestamp}]</span> <span class="event-type">${entry.type}</span> <span class="event-data">${entry.data}</span></div>`).join('')}window.addEventListener('message',e=>{if(e.data.type==='header-state'){document.getElementById('headerColor').textContent=e.data.color;document.getElementById('headerVisible').textContent=e.data.visible?'âœ“':'âœ—';document.getElementById('headerColorBox').style.backgroundColor=e.data.color;logEvent('header',`${e.data.color} ${e.data.visible?'âœ“':'âœ—'}`)}});function testScrollToTop(){const iframe=document.getElementById('testIframe');iframe.contentWindow.scrollTo({top:0,behavior:'smooth'});logEvent('test','Scroll top')}function testScrollToBottom(){const iframe=document.getElementById('testIframe');const doc=iframe.contentDocument;iframe.contentWindow.scrollTo({top:doc.documentElement.scrollHeight,behavior:'smooth'});logEvent('test','Scroll bottom')}function testScrollToDark(){const iframe=document.getElementById('testIframe');const section=iframe.contentDocument.querySelector('.section-1');section.scrollIntoView({behavior:'smooth'});logEvent('test','Scroll dark')}function testScrollToLight(){const iframe=document.getElementById('testIframe');const section=iframe.contentDocument.querySelector('.section-4');section.scrollIntoView({behavior:'smooth'});logEvent('test','Scroll light')}function testChangeHeaderColor(){const iframe=document.getElementById('testIframe');iframe.contentWindow.postMessage({type:'set-header-color',color:'#'+Math.floor(Math.random()*16777215).toString(16)},'*');logEvent('test','Random color')}function testToggleHeader(){const iframe=document.getElementById('testIframe');iframe.contentWindow.postMessage({type:'toggle-header'},'*');logEvent('test','Toggle header')}document.getElementById('autoColorChange').addEventListener('change',e=>{const iframe=document.getElementById('testIframe');iframe.contentWindow.postMessage({type:'set-auto-color',enabled:e.target.checked},'*');logEvent('test',`Auto: ${e.target.checked?'ON':'OFF'}`)});document.getElementById('manualHeaderColor').addEventListener('change',e=>{const iframe=document.getElementById('testIframe');iframe.contentWindow.postMessage({type:'set-header-color',color:e.target.value},'*');logEvent('test',`Color: ${e.target.value}`)});let colorAnalyzer;document.getElementById('samplingRateSlider').addEventListener('input',e=>{const rate=parseInt(e.target.value);document.getElementById('samplingRateValue').textContent=`${rate} Hz`;document.getElementById('samplingRateLabel').textContent=`Idle Sampling Rate: ${rate} Hz`;if(colorAnalyzer){colorAnalyzer.setSamplingRate(rate)}});const iframe=document.getElementById('testIframe');iframe.addEventListener('load',()=>{logEvent('system','Iframe loaded');const iframeDoc=iframe.contentDocument||iframe.contentWindow.document;const scrollableElement=iframeDoc.documentElement;const scrollBridge=new IframeScrollBridge(iframe,scrollableElement);scrollBridge.start();logEvent('system','Bridge started');colorAnalyzer=new StatusBarColorAnalyzer({scrollSource:'iframe',iframeBridge:scrollBridge,scrollableContent:scrollableElement,statusBar:document.getElementById('statusBar')});colorAnalyzer.init().then(()=>{logEvent('system','Analyzer ready âœ“')})})</script></body></html>